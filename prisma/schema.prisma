datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  engineType = "wasm"
}

model Project {
  id          String   @id @default(uuid())
  name        String
  path        String   @unique
  description String?
  type        String?  // e.g., "NEXTJS", "PYTHON", "JAVA"
  tier        String   @default("STANDARD") // "STANDARD", "ENTERPRISE"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  analyses    AnalysisExecute[]
  stats       ProjectStats[]
  ruleSets    RuleSet[]
  risks       RiskAssessment[]
  techDebts   TechDebt[]
  decisions   DecisionRecord[]
  selfProject SelfProject?
}

// --- Self-Analysis (서비스 자기 분석) ---

// 기본 프로젝트 (Self-Analysis용)
model SelfProject {
  id              String   @id @default(uuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type            String   @default("internal-core") // internal-core 고정
  undeletable     Boolean  @default(true)
  tags            String   @default("[\"self\",\"reference\",\"baseline\"]") // JSON array
  
  visibility      String   @default("admin-only") // "admin-only", "operator", "all"
  
  // 자동 등록 정보
  registeredAt    DateTime @default(now())
  registeredBy    String   @default("SYSTEM")
  
  // 분석 트리거 설정
  triggerOnPush   Boolean  @default(true)
  triggerOnMerge  Boolean  @default(true)
  triggerOnBuild  Boolean  @default(true)
  triggerOnDeploy Boolean  @default(true)
  scheduleDaily   Boolean  @default(true)
  
  baselines       Baseline[]
  policies        SelfAnalysisPolicy[]
  triggers        AnalysisTrigger[]
  backlogItems    BacklogItem[]
}

// 기준선 (Baseline)
model Baseline {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  version         Int      @default(1)
  status          String   @default("ACTIVE") // "ACTIVE", "LOCKED", "SUPERSEDED"
  
  // 지표
  complexityScore Float?
  debtScore       Float?
  riskScore       Float?
  qualityScore    Float?
  securityScore   Float?
  coverageScore   Float?
  
  // 상세 데이터 (JSON)
  metrics         String?
  
  // 관리
  isLocked        Boolean  @default(false)
  lockedAt        DateTime?
  lockedBy        String?
  
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 분석 트리거 이벤트
model AnalysisTrigger {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  type            String   // "GIT_PUSH", "GIT_MERGE", "CI_BUILD", "DEPLOY", "SCHEDULE", "MANUAL"
  source          String?  // Git commit SHA, Build ID, etc.
  
  status          String   @default("PENDING") // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  executionId     String?  // AnalysisExecute ID
  
  triggeredAt     DateTime @default(now())
  triggeredBy     String?
  completedAt     DateTime?
  
  errorMessage    String?
}

// Self-Analysis 전용 분석 정책
model SelfAnalysisPolicy {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  name            String
  isActive        Boolean  @default(true)
  
  // 정책 설정
  failureTolerance        Int      @default(0)   // 실패 허용 Zero
  warningThreshold        Float    @default(0.8) // 외부보다 엄격
  confidenceWeight        Float    @default(1.0) // 최고 신뢰도
  
  requireExplanation      Boolean  @default(true)  // 설명 필수
  requireHumanApproval    Boolean  @default(true)  // 휴먼 승인 필수
  blockOnThresholdExceeded Boolean @default(true) // 임계 초과 시 배포 차단
  
  // 에이전트별 설정 (JSON)
  agentSettings           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 자동 생성 백로그 아이템
model BacklogItem {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  title           String
  description     String
  category        String   // "BUG", "IMPROVEMENT", "SECURITY", "TECH_DEBT"
  priority        String   @default("MEDIUM") // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  
  status          String   @default("OPEN") // "OPEN", "IN_PROGRESS", "RESOLVED", "WONT_FIX"
  sourceResultId  String?  // 분석 결과 ID
  
  estimatedHours  Int?
  assignedTo      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  resolvedAt      DateTime?
}

model AnalysisExecute {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  score       Float?
  report      String? // Markdown report
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Reliability & Operations
  inputHash   String?  // SHA-256 integrity check
  snapshotPath String? // Path to project snapshot
  environment String?  // "DEV", "STAGE", "PROD"
  
  results     AnalysisResult[]
  agentExecutions AgentExecution[]
  dependencies Dependency[]
  approvalWorkflows ApprovalWorkflow[]
}

model AnalysisResult {
  id              String          @id @default(uuid())
  executeId       String
  execute         AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  category        String          // "QUALITY", "SECURITY", "ARCHITECTURE", "PERFORMANCE", "OPERATIONS"
  severity        String          // "INFO", "LOW", "MEDIUM", "HIGH", "CRITICAL"
  filePath        String?
  lineNumber      Int?
  message         String
  suggestion      String?
  confidenceScore Float           @default(1.0)
  reasoning       String?         // Explainable AI reasoning
  createdAt       DateTime        @default(now())

  // Expert Review
  reviewStatus    String          @default("OPEN") // "OPEN", "FIXED", "FALSE_POSITIVE", "WONT_FIX", "IN_PROGRESS"
  reviewComment   String?
  humanCorrection String?         // Expert manual correction
  isFlagged       Boolean         @default(false)
  
  comments        Comment[]
  
  // Relations to specific details
  vulnerability   Vulnerability?
  architecturalIssue ArchitecturalIssue?
}


model AgentExecution {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  agentName   String   // e.g., "StructureAnalysisAgent"
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  durationMs  Int?
  tokensUsed  Int?
  createdAt   DateTime @default(now())
  completedAt DateTime?

  tasks       AgentTask[]
}

model AgentTask {
  id              String         @id @default(uuid())
  agentExecutionId String
  agentExecution  AgentExecution @relation(fields: [agentExecutionId], references: [id], onDelete: Cascade)
  
  status          String         // "QUEUED", "RUNNING", "COMPLETED", "FAILED", "TIMED_OUT"
  target          String         // "file:lib/utils.ts" or "module:auth"
  retryCount      Int            @default(0)
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  resultSummary   String?        // JSON summary of results

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}


model ProjectStats {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timestamp       DateTime @default(now())
  codeQualityScore Float?
  securityScore   Float?
  maintainabilityScore Float?
  opsRiskScore    Float?
}

// --- Governance & Rules ---

model RuleSet {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isActive    Boolean  @default(true)
  rules       Rule[]
}

model Rule {
  id          String   @id @default(uuid())
  ruleSetId   String
  ruleSet     RuleSet  @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  key         String   // e.g., "no-console-log", "max-depth"
  config      String?  // JSON config
  severity    String   @default("MEDIUM")
  category    String
}

// --- Security ---

model Vulnerability {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  cveId           String?
  cvssScore       Float?
  vector          String?
  remediation     String?
}

// --- Architecture ---

model ArchitecturalIssue {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  issueType       String         // "CYCLE", "LAYER_VIOLATION", "DRIFT"
  sourceComponent String?
  targetComponent String?
}

model ServiceBoundary {
  id          String   @id @default(uuid())
  name        String
  description String?
  definition  String? // Glob pattern or parsing rule
}

// --- Operations & Risk ---

model RiskAssessment {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  riskLevel   String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  mttrEstimate Int?    // Hours
  failureProb  Float?  // 0-1
  createdAt   DateTime @default(now())
}

model Dependency {
  id        String   @id @default(uuid())
  executeId String
  execute   AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  from      String
  to        String
  type      String   // "IMPORT", "DYNAMIC"
}

// --- Enterprise & Reliability Features ---

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // "ANALYSIS_START", "RESULT_MODIFIED", "APPROVED", "EXPORTED"
  actorId     String?  // User ID or System Agent Name
  targetType  String   // "PROJECT", "ANALYSIS", "RESULT"
  targetId    String
  details     String?  // JSON details
  timestamp   DateTime @default(now())
  ipAddress   String?
}

model TechDebt {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category      String   // "CODE", "ARCHITECTURE", "OPERATIONS", "SECURITY"
  issueCount    Int
  remediationCostHours Int?
  remediationCostCurrency Float?
  riskFactor    Float?   // 0-1 probability of failure if ignored
  createdAt     DateTime @default(now())
}

model ApprovalWorkflow {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  stepName    String   // "Security Review", "Arch Review"
  status      String   // "PENDING", "APPROVED", "REJECTED"
  approverId  String?
  comment     String?
  updatedAt   DateTime @updatedAt
}

model Comment {
  id          String   @id @default(uuid())
  resultId    String
  result      AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  authorId    String
  content     String
  createdAt   DateTime @default(now())
}

model DecisionRecord {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String
  status      String   // "PROPOSED", "ACCEPTED", "REJECTED"
  decidedBy   String
  decidedAt   DateTime @default(now())
}

// --- MLOps & Stats Extensions ---

model ModelExecution {
  id          String   @id @default(uuid())
  agentExecId String   
  modelName   String
  modelVersion String
  latencyMs   Int
  inputTokens Int
  outputTokens Int
  drift       Float?   // 0-1 drift score
  createdAt   DateTime @default(now())
}
