datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
  engineType = "wasm"
}

model Project {
  id          String   @id @default(uuid())
  name        String
  path        String   @unique
  description String?
  type        String?  // e.g., "NEXTJS", "PYTHON", "JAVA"
  tier        String   @default("STANDARD") // "STANDARD", "ENTERPRISE"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  analyses    AnalysisExecute[]
  stats       ProjectStats[]
  ruleSets    RuleSet[]
  risks       RiskAssessment[]
  techDebts   TechDebt[]
  decisions   DecisionRecord[]
}

model AnalysisExecute {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  score       Float?
  report      String? // Markdown report
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Reliability & Operations
  inputHash   String?  // SHA-256 integrity check
  snapshotPath String? // Path to project snapshot
  environment String?  // "DEV", "STAGE", "PROD"
  
  results     AnalysisResult[]
  agentExecutions AgentExecution[]
  dependencies Dependency[]
  approvalWorkflows ApprovalWorkflow[]
}

model AnalysisResult {
  id              String          @id @default(uuid())
  executeId       String
  execute         AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  category        String          // "QUALITY", "SECURITY", "ARCHITECTURE", "PERFORMANCE", "OPERATIONS"
  severity        String          // "INFO", "LOW", "MEDIUM", "HIGH", "CRITICAL"
  filePath        String?
  lineNumber      Int?
  message         String
  suggestion      String?
  confidenceScore Float           @default(1.0)
  reasoning       String?         // Explainable AI reasoning
  createdAt       DateTime        @default(now())

  // Expert Review
  reviewStatus    String          @default("OPEN") // "OPEN", "FIXED", "FALSE_POSITIVE", "WONT_FIX", "IN_PROGRESS"
  reviewComment   String?
  humanCorrection String?         // Expert manual correction
  isFlagged       Boolean         @default(false)
  
  comments        Comment[]
  
  // Relations to specific details
  vulnerability   Vulnerability?
  architecturalIssue ArchitecturalIssue?
}


model AgentExecution {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  agentName   String   // e.g., "StructureAnalysisAgent"
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  durationMs  Int?
  tokensUsed  Int?
  createdAt   DateTime @default(now())
  completedAt DateTime?

  tasks       AgentTask[]
}

model AgentTask {
  id              String         @id @default(uuid())
  agentExecutionId String
  agentExecution  AgentExecution @relation(fields: [agentExecutionId], references: [id], onDelete: Cascade)
  
  status          String         // "QUEUED", "RUNNING", "COMPLETED", "FAILED", "TIMED_OUT"
  target          String         // "file:lib/utils.ts" or "module:auth"
  retryCount      Int            @default(0)
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  resultSummary   String?        // JSON summary of results

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}


model ProjectStats {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timestamp       DateTime @default(now())
  codeQualityScore Float?
  securityScore   Float?
  maintainabilityScore Float?
  opsRiskScore    Float?
}

// --- Governance & Rules ---

model RuleSet {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isActive    Boolean  @default(true)
  rules       Rule[]
}

model Rule {
  id          String   @id @default(uuid())
  ruleSetId   String
  ruleSet     RuleSet  @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  key         String   // e.g., "no-console-log", "max-depth"
  config      String?  // JSON config
  severity    String   @default("MEDIUM")
  category    String
}

// --- Security ---

model Vulnerability {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  cveId           String?
  cvssScore       Float?
  vector          String?
  remediation     String?
}

// --- Architecture ---

model ArchitecturalIssue {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  issueType       String         // "CYCLE", "LAYER_VIOLATION", "DRIFT"
  sourceComponent String?
  targetComponent String?
}

model ServiceBoundary {
  id          String   @id @default(uuid())
  name        String
  description String?
  definition  String? // Glob pattern or parsing rule
}

// --- Operations & Risk ---

model RiskAssessment {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  riskLevel   String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  mttrEstimate Int?    // Hours
  failureProb  Float?  // 0-1
  createdAt   DateTime @default(now())
}

model Dependency {
  id        String   @id @default(uuid())
  executeId String
  execute   AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  from      String
  to        String
  type      String   // "IMPORT", "DYNAMIC"
}

// --- Enterprise & Reliability Features ---

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // "ANALYSIS_START", "RESULT_MODIFIED", "APPROVED", "EXPORTED"
  actorId     String?  // User ID or System Agent Name
  targetType  String   // "PROJECT", "ANALYSIS", "RESULT"
  targetId    String
  details     String?  // JSON details
  timestamp   DateTime @default(now())
  ipAddress   String?
}

model TechDebt {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category      String   // "CODE", "ARCHITECTURE", "OPERATIONS", "SECURITY"
  issueCount    Int
  remediationCostHours Int?
  remediationCostCurrency Float?
  riskFactor    Float?   // 0-1 probability of failure if ignored
  createdAt     DateTime @default(now())
}

model ApprovalWorkflow {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  stepName    String   // "Security Review", "Arch Review"
  status      String   // "PENDING", "APPROVED", "REJECTED"
  approverId  String?
  comment     String?
  updatedAt   DateTime @updatedAt
}

model Comment {
  id          String   @id @default(uuid())
  resultId    String
  result      AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  authorId    String
  content     String
  createdAt   DateTime @default(now())
}

model DecisionRecord {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String
  status      String   // "PROPOSED", "ACCEPTED", "REJECTED"
  decidedBy   String
  decidedAt   DateTime @default(now())
}

// --- MLOps & Stats Extensions ---

model ModelExecution {
  id          String   @id @default(uuid())
  agentExecId String   
  modelName   String
  modelVersion String
  latencyMs   Int
  inputTokens Int
  outputTokens Int
  drift       Float?   // 0-1 drift score
  createdAt   DateTime @default(now())
}
