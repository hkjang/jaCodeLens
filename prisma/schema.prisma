datasource db {
  provider = "sqlite"
}

generator client {
  provider = "prisma-client-js"
}

model Project {
  id          String   @id @default(uuid())
  name        String
  path        String   @unique
  description String?
  type        String?  // e.g., "NEXTJS", "PYTHON", "JAVA"
  tier        String   @default("STANDARD") // "STANDARD", "ENTERPRISE"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  analyses     AnalysisExecute[]
  stats        ProjectStats[]
  ruleSets     RuleSet[]
  risks        RiskAssessment[]
  techDebts    TechDebt[]
  decisions    DecisionRecord[]
  selfProject  SelfProject?
  codeElements CodeElement[]
}

// --- Code Intelligence (코드 요소 추출/분석) ---

model CodeElement {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // 파일 정보
  filePath        String   // 상대 경로 (프로젝트 루트 기준)
  fileName        String   // 파일명
  language        String   // TypeScript, JavaScript, Python 등
  
  // 코드 요소 정보
  elementType     String   // CLASS, FUNCTION, METHOD, VARIABLE, INTERFACE, TYPE, COMPONENT
  name            String   // 요소 이름
  signature       String?  // 함수/메서드 시그니처
  lineStart       Int      // 시작 줄
  lineEnd         Int      // 끝 줄
  content         String   // 실제 코드 내용 (최대 5000자)
  
  // 컨텍스트
  parentName      String?  // 부모 클래스/함수 이름
  exportType      String?  // default, named, none
  isAsync         Boolean  @default(false)
  isExported      Boolean  @default(false)
  
  // AI 분석 결과
  aiSummary       String?  // AI가 생성한 한글 요약
  aiAnalysis      String?  // AI 분석 결과 (JSON)
  analyzedAt      DateTime?
  
  // 메타
  hash            String?  // 내용 해시 (변경 감지용)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([projectId, filePath])
  @@index([projectId, elementType])
  @@index([projectId, name])
}

// --- Self-Analysis (서비스 자기 분석) ---


// 기본 프로젝트 (Self-Analysis용)
model SelfProject {
  id              String   @id @default(uuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type            String   @default("internal-core") // internal-core 고정
  undeletable     Boolean  @default(true)
  tags            String   @default("[\"self\",\"reference\",\"baseline\"]") // JSON array
  
  visibility      String   @default("admin-only") // "admin-only", "operator", "all"
  
  // 자동 등록 정보
  registeredAt    DateTime @default(now())
  registeredBy    String   @default("SYSTEM")
  
  // 분석 트리거 설정
  triggerOnPush   Boolean  @default(true)
  triggerOnMerge  Boolean  @default(true)
  triggerOnBuild  Boolean  @default(true)
  triggerOnDeploy Boolean  @default(true)
  scheduleDaily   Boolean  @default(true)
  
  baselines       Baseline[]
  policies        SelfAnalysisPolicy[]
  triggers        AnalysisTrigger[]
  backlogItems    BacklogItem[]
}

// 기준선 (Baseline)
model Baseline {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  version         Int      @default(1)
  status          String   @default("ACTIVE") // "ACTIVE", "LOCKED", "SUPERSEDED"
  
  // 지표
  complexityScore Float?
  debtScore       Float?
  riskScore       Float?
  qualityScore    Float?
  securityScore   Float?
  coverageScore   Float?
  
  // 상세 데이터 (JSON)
  metrics         String?
  
  // 관리
  isLocked        Boolean  @default(false)
  lockedAt        DateTime?
  lockedBy        String?
  
  approvedBy      String?
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 분석 트리거 이벤트
model AnalysisTrigger {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  type            String   // "GIT_PUSH", "GIT_MERGE", "CI_BUILD", "DEPLOY", "SCHEDULE", "MANUAL"
  source          String?  // Git commit SHA, Build ID, etc.
  
  status          String   @default("PENDING") // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  executionId     String?  // AnalysisExecute ID
  
  triggeredAt     DateTime @default(now())
  triggeredBy     String?
  completedAt     DateTime?
  
  errorMessage    String?
}

// Self-Analysis 전용 분석 정책
model SelfAnalysisPolicy {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  name            String
  isActive        Boolean  @default(true)
  
  // 정책 설정
  failureTolerance        Int      @default(0)   // 실패 허용 Zero
  warningThreshold        Float    @default(0.8) // 외부보다 엄격
  confidenceWeight        Float    @default(1.0) // 최고 신뢰도
  
  requireExplanation      Boolean  @default(true)  // 설명 필수
  requireHumanApproval    Boolean  @default(true)  // 휴먼 승인 필수
  blockOnThresholdExceeded Boolean @default(true) // 임계 초과 시 배포 차단
  
  // 에이전트별 설정 (JSON)
  agentSettings           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// 자동 생성 백로그 아이템
model BacklogItem {
  id              String   @id @default(uuid())
  selfProjectId   String
  selfProject     SelfProject @relation(fields: [selfProjectId], references: [id], onDelete: Cascade)
  
  title           String
  description     String
  category        String   // "BUG", "IMPROVEMENT", "SECURITY", "TECH_DEBT"
  priority        String   @default("MEDIUM") // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  
  status          String   @default("OPEN") // "OPEN", "IN_PROGRESS", "RESOLVED", "WONT_FIX"
  sourceResultId  String?  // 분석 결과 ID
  
  estimatedHours  Int?
  assignedTo      String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  resolvedAt      DateTime?
}

model AnalysisExecute {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  score       Float?
  report      String? // Markdown report
  startedAt   DateTime @default(now())
  completedAt DateTime?
  
  // Reliability & Operations
  inputHash   String?  // SHA-256 integrity check
  snapshotPath String? // Path to project snapshot
  environment String?  // "DEV", "STAGE", "PROD"
  
  results     AnalysisResult[]
  agentExecutions AgentExecution[]
  dependencies Dependency[]
  approvalWorkflows ApprovalWorkflow[]
  normalizedResults NormalizedAnalysisResult[]
}

model AnalysisResult {
  id              String          @id @default(uuid())
  executeId       String
  execute         AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  category        String          // "QUALITY", "SECURITY", "ARCHITECTURE", "PERFORMANCE", "OPERATIONS"
  severity        String          // "INFO", "LOW", "MEDIUM", "HIGH", "CRITICAL"
  filePath        String?
  lineNumber      Int?
  message         String
  suggestion      String?
  confidenceScore Float           @default(1.0)
  reasoning       String?         // Explainable AI reasoning
  createdAt       DateTime        @default(now())

  // Expert Review
  reviewStatus    String          @default("OPEN") // "OPEN", "FIXED", "FALSE_POSITIVE", "WONT_FIX", "IN_PROGRESS"
  reviewComment   String?
  humanCorrection String?         // Expert manual correction
  isFlagged       Boolean         @default(false)
  
  comments        Comment[]
  
  // Relations to specific details
  vulnerability   Vulnerability?
  architecturalIssue ArchitecturalIssue?
}

// --- Deterministic Pipeline Results (새 파이프라인 정규화 결과) ---

model NormalizedAnalysisResult {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  
  // 위치 정보
  filePath    String
  lineStart   Int
  lineEnd     Int
  
  // 분류 정보
  language    String   // typescript, javascript, python, java, etc.
  mainCategory String  // STRUCTURE, QUALITY, SECURITY, OPERATIONS, TEST, STANDARDS
  subCategory String   // LAYER, CIRCULAR, COMPLEXITY, DUPLICATION, INJECTION, XSS, etc.
  ruleId      String   // SEC001, STY010, ARCH001, etc.
  severity    String   // CRITICAL, HIGH, MEDIUM, LOW, INFO
  
  // 내용
  message     String
  suggestion  String?
  
  // 원본 데이터 (JSON)
  rawResult   String?
  
  // AI 보강 필드 (정규화 이후에만 채워짐)
  aiExplanation   String?
  aiSuggestion    String?
  aiSecurityAdvice String?
  
  // 메타데이터
  deterministic Boolean @default(true)  // AI 없이 생성된 결과인지
  createdAt   DateTime @default(now())
  
  @@index([executeId, severity])
  @@index([executeId, mainCategory])
  @@index([filePath])
}

// 파이프라인 실행 스테이지 추적
model PipelineStageExecution {
  id          String   @id @default(uuid())
  executeId   String
  
  stage       String   // SOURCE_COLLECT, LANGUAGE_DETECT, AST_PARSE, etc.
  status      String   // pending, running, completed, failed, skipped
  progress    Int      @default(0)  // 0-100
  message     String?
  error       String?
  
  startedAt   DateTime?
  completedAt DateTime?
  
  createdAt   DateTime @default(now())
  
  @@index([executeId])
}


model AgentExecution {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  agentName   String   // e.g., "StructureAnalysisAgent"
  status      String   // "PENDING", "RUNNING", "COMPLETED", "FAILED"
  durationMs  Int?
  tokensUsed  Int?
  createdAt   DateTime @default(now())
  completedAt DateTime?

  tasks       AgentTask[]
}

model AgentTask {
  id              String         @id @default(uuid())
  agentExecutionId String
  agentExecution  AgentExecution @relation(fields: [agentExecutionId], references: [id], onDelete: Cascade)
  
  status          String         // "QUEUED", "RUNNING", "COMPLETED", "FAILED", "TIMED_OUT"
  target          String         // "file:lib/utils.ts" or "module:auth"
  retryCount      Int            @default(0)
  errorMessage    String?
  startedAt       DateTime?
  completedAt     DateTime?
  resultSummary   String?        // JSON summary of results

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
}


model ProjectStats {
  id              String   @id @default(uuid())
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  timestamp       DateTime @default(now())
  codeQualityScore Float?
  securityScore   Float?
  maintainabilityScore Float?
  opsRiskScore    Float?
}

// --- Governance & Rules ---

model RuleSet {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  name        String
  description String?
  isActive    Boolean  @default(true)
  rules       Rule[]
}

model Rule {
  id          String   @id @default(uuid())
  ruleSetId   String
  ruleSet     RuleSet  @relation(fields: [ruleSetId], references: [id], onDelete: Cascade)
  key         String   // e.g., "no-console-log", "max-depth"
  config      String?  // JSON config
  severity    String   @default("MEDIUM")
  category    String
}

// --- Security ---

model Vulnerability {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  cveId           String?
  cvssScore       Float?
  vector          String?
  remediation     String?
}

// --- Architecture ---

model ArchitecturalIssue {
  id              String         @id @default(uuid())
  resultId        String         @unique
  result          AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  issueType       String         // "CYCLE", "LAYER_VIOLATION", "DRIFT"
  sourceComponent String?
  targetComponent String?
}

model ServiceBoundary {
  id          String   @id @default(uuid())
  name        String
  description String?
  definition  String? // Glob pattern or parsing rule
}

// --- Operations & Risk ---

model RiskAssessment {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  riskLevel   String   // "LOW", "MEDIUM", "HIGH", "CRITICAL"
  mttrEstimate Int?    // Hours
  failureProb  Float?  // 0-1
  createdAt   DateTime @default(now())
}

model Dependency {
  id        String   @id @default(uuid())
  executeId String
  execute   AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  from      String
  to        String
  type      String   // "IMPORT", "DYNAMIC"
}

// --- Enterprise & Reliability Features ---

model AuditLog {
  id          String   @id @default(uuid())
  action      String   // "ANALYSIS_START", "RESULT_MODIFIED", "APPROVED", "EXPORTED"
  actorId     String?  // User ID or System Agent Name
  targetType  String   // "PROJECT", "ANALYSIS", "RESULT"
  targetId    String
  details     String?  // JSON details
  timestamp   DateTime @default(now())
  ipAddress   String?
}

model TechDebt {
  id            String   @id @default(uuid())
  projectId     String
  project       Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  category      String   // "CODE", "ARCHITECTURE", "OPERATIONS", "SECURITY"
  issueCount    Int
  remediationCostHours Int?
  remediationCostCurrency Float?
  riskFactor    Float?   // 0-1 probability of failure if ignored
  createdAt     DateTime @default(now())
}

model ApprovalWorkflow {
  id          String   @id @default(uuid())
  executeId   String
  execute     AnalysisExecute @relation(fields: [executeId], references: [id], onDelete: Cascade)
  stepName    String   // "Security Review", "Arch Review"
  status      String   // "PENDING", "APPROVED", "REJECTED"
  approverId  String?
  comment     String?
  updatedAt   DateTime @updatedAt
}

model Comment {
  id          String   @id @default(uuid())
  resultId    String
  result      AnalysisResult @relation(fields: [resultId], references: [id], onDelete: Cascade)
  authorId    String
  content     String
  createdAt   DateTime @default(now())
}

model DecisionRecord {
  id          String   @id @default(uuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String
  status      String   // "PROPOSED", "ACCEPTED", "REJECTED"
  decidedBy   String
  decidedAt   DateTime @default(now())
}

// --- MLOps & Stats Extensions ---

model ModelExecution {
  id          String   @id @default(uuid())
  agentExecId String   
  modelName   String
  modelVersion String
  latencyMs   Int
  inputTokens Int
  outputTokens Int
  drift       Float?   // 0-1 drift score
  createdAt   DateTime @default(now())
}

// --- AI Model Configuration ---

model AiModel {
  id          String   @id @default(uuid())
  name        String   // e.g., "qwen3:8b", "gpt-4o"
  provider    String   // e.g., "Ollama", "OpenAI", "Anthropic"
  version     String?  // e.g., "2024-05"
  endpoint    String?  // API endpoint URL for Ollama or custom providers
  apiKey      String?  // API key (encrypted or null for local models)
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  // Performance metrics
  latency     Float    @default(0)   // Average latency in seconds
  accuracy    Float    @default(0)   // Accuracy percentage (0-100)
  costPerToken Float   @default(0)   // Cost per 1K tokens
  
  // Usage tracking
  usageToday  Int      @default(0)
  usageTotal  Int      @default(0)
  
  // Configuration
  contextWindow Int?   // Max context window size
  maxTokens     Int?   // Max output tokens
  temperature   Float  @default(0.7)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- AI Prompt Management ---

model AiPrompt {
  id                 String   @id @default(uuid())
  key                String   @unique  // e.g., "ai-judge.synthesis"
  name               String              // Display name
  description        String?             // Description
  category           String              // ANALYSIS, JUDGE, AGENT, etc.
  systemPrompt       String              // System prompt content
  userPromptTemplate String?             // User prompt template with {{variables}}
  variables          String?             // JSON array of available variables
  isActive           Boolean  @default(true)
  version            Int      @default(1)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  // Relation to agents
  agents             AgentConfig[]
}

// --- Agent Configuration ---

model AgentConfig {
  id           String   @id @default(uuid())
  name         String   @unique  // e.g., "SecurityAnalysisAgent"
  displayName  String              // Display name in UI
  description  String?             // Agent description
  category     String   @default("ANALYSIS")  // ANALYSIS, SECURITY, QUALITY, etc.
  
  // Execution settings
  isEnabled    Boolean  @default(true)
  priority     Int      @default(1)       // Lower = higher priority
  timeout      Int      @default(60)      // Timeout in seconds
  maxRetries   Int      @default(3)       // Max retry attempts
  
  // Relations
  promptId     String?             // Connected prompt key
  prompt       AiPrompt? @relation(fields: [promptId], references: [id])
  modelId      String?             // Specific model override (null = use default)
  
  // Status and metrics
  status       String   @default("idle")  // idle, active, error
  lastRunAt    DateTime?
  totalRuns    Int      @default(0)
  successRuns  Int      @default(0)
  failedRuns   Int      @default(0)
  avgDuration  Float    @default(0)
  
  // Config
  config       String?             // JSON additional config
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// --- Admin: Role Management ---
model AdminRole {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions String   @default("[]")  // JSON array of permission keys
  userCount   Int      @default(0)
  isSystem    Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- Admin: Analysis Policy ---
model AdminPolicy {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  category    String   @default("other")  // Security, Quality, Architecture, etc
  isActive    Boolean  @default(true)
  rules       String   @default("[]")     // JSON array of rules
  priority    Int      @default(0)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
